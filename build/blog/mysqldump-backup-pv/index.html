



<!DOCTYPE html>
<html>
    <head>
    <title>Sopa de bits</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="description" content="A blog about data, information and Tech by Mario Alberich"/>
    <meta name="keywords" content="Statistics, Data, Experimentation, Technology, Data visualization" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/static/css/bootstrap/bootstrap.css"/>
    <link rel="stylesheet" href="/static/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="/static/js/cookiecuttr/cookiecuttr.css"/>
    <link rel="stylesheet" href="/static/css/style.css"/>
    <link rel="stylesheet" href="/static/css/bootstrap/bootstrap.min.css" media="print"/>
    <link rel="stylesheet" href="/static/css/bootstrap/bootstrap-theme.min.css" media="print" />
    </head>
    <body>
    <div class="container-fluid">
      <div class="row">
        <div class="col-xs-12 col-sm-3 col-md-2 nopad-l">
          <div class="sidebar-nav-fixed affix hidden-sm">
            <div class="well">
              <div class="row">
                <!-- <div class="col-xs-12">
                  <input class="form-control" type="text" id="search-query" name="q" placeholder="Search in sopadebits.com" data-toggle="popover" autocomplete="off">
                </div> -->
                <div class="col-xs-12 text-center">
                  <a href="https://sopadebits.com"><h1>Sopa de bits</h1></a>
                </div>
                <div class="col-xs-8 col-xs-offset-2 text-center">
                  <a href="https://sopadebits.com">
                    <img src="/static/images/avatar.jpg"
                      class="img img-responsive img-circle"
                      alt="Sopa de bits"
                      title="Sopa de bits" />
                  </a>
                </div>
                <div class="col-sm-10 col-sm-offset-1 hidden-xs text-center">
                  <p>A blog about data, information and Tech by Mario Alberich</p>
                </div>
                <div class="col-sm-12 hidden-xs" rel="icons">
                  
  
    <a target="_new" href="https://linkedin.com/in/marioalberich" alt="LinkedIn" title="LinkedIn">
      <span class="icon fa fa-2x fa-linkedin"></span>
    </a>&nbsp;&nbsp;
  
  
    <a target="_new" href="https://twitter.com/sopadebits" alt="Twitter" title="Twitter">
      <span class="icon fa fa-2x fa-twitter"></span>
    </a>&nbsp;&nbsp;
  
  
  
    <a target="_new" href="https://github.com/malberich" alt="Github profile" title="Github profile">
      <span class="icon fa fa-2x fa-github"></span>
    </a>&nbsp;&nbsp;
  
  
  
    <a target="_new" href="https://marioalberich.com" alt="Portfolio" title="Portfolio">
      <span class="icon fa fa-2x fa-user"></span>
    </a>
  

                </div>
                <div class="col-sm-10 col-sm-offset-1 hidden-xs">
                  
  <!-- render_site_categories -->
  <h3>Categories</h3>
  <div class="row">
    
      <div class="col-xs-2">
        <span class="badge">45</span>
      </div>
      <div class="col-xs-10">
        <a href="/categories/documentacion/">Documentación</a>
      </div>
      <div class="col-xs-2">
        <span class="badge">40</span>
      </div>
      <div class="col-xs-10">
        <a href="/categories/economia/">Economía</a>
      </div>
      <div class="col-xs-2">
        <span class="badge">139</span>
      </div>
      <div class="col-xs-10">
        <a href="/categories/informatica/">Informática</a>
      </div>
      <div class="col-xs-2">
        <span class="badge">82</span>
      </div>
      <div class="col-xs-10">
        <a href="/categories/matematica/">Matemática</a>
      </div>
      <div class="col-xs-2">
        <span class="badge">1</span>
      </div>
      <div class="col-xs-10">
        <a href="/categories/miscelanea/">Miscelánea</a>
      </div>
      <div class="col-xs-2">
        <span class="badge">8</span>
      </div>
      <div class="col-xs-10">
        <a href="/categories/ocio/">Ocio</a>
      </div>
      <div class="col-xs-2">
        <span class="badge">11</span>
      </div>
      <div class="col-xs-10">
        <a href="/categories/personas/">Personas</a>
      </div>
      <div class="col-xs-2">
        <span class="badge">7</span>
      </div>
      <div class="col-xs-10">
        <a href="/categories/sin-categorizar/">Sin categorizar</a>
      </div>
  </div>

                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="jumbotron visible-sm visible-xs">
            <div class="row">
                <div class="col-sm-2 col-sm-offset-0 col-xs-4 col-xs-offset-4 text-center">
                    <a href="https://sopadebits.com">
                        <img src="/static/images/avatar.jpg"
                          class="img img-responsive img-circle"
                          alt="Sopa de bits"
                          title="Sopa de bits" />
                    </a>
                </div>
                <div class="col-sm-10 col-xs-12">
                    <h1 class="hidden-xs"><a href="https://sopadebits.com">Sopa de bits</a></h1>
                    <h1 class="visible-xs text-center"><a href="https://sopadebits.com">Sopa de bits</a></h1>
                </div>
              </div>
              <div class="row">
                <div class="col-sm-10 col-sm-offset-1 col-xs-12 text-center">
                  <p>A blog about data, information and Tech by Mario Alberich</p>
                </div>
                <div class="col-xs-12" rel="icons">
                  
  
    <a target="_new" href="https://linkedin.com/in/marioalberich" alt="LinkedIn" title="LinkedIn">
      <span class="icon fa fa-2x fa-linkedin"></span>
    </a>&nbsp;&nbsp;
  
  
    <a target="_new" href="https://twitter.com/sopadebits" alt="Twitter" title="Twitter">
      <span class="icon fa fa-2x fa-twitter"></span>
    </a>&nbsp;&nbsp;
  
  
  
    <a target="_new" href="https://github.com/malberich" alt="Github profile" title="Github profile">
      <span class="icon fa fa-2x fa-github"></span>
    </a>&nbsp;&nbsp;
  
  
  
    <a target="_new" href="https://marioalberich.com" alt="Portfolio" title="Portfolio">
      <span class="icon fa fa-2x fa-user"></span>
    </a>
  

                </div>
            </div>
        </div>
        <!-- <div
          id="search-results"
          style="background-color: #fff; border: 1px solid black; z-index:125; height: 50%; overflow: scroll; display: none; position:absolute" class="col-xs-12 col-sm-4 col-sm-offset-2">
        </div> -->
        <div class="col-xs-12 col-md-10 col-md-offset-2">
          
  
    
        <h1>mysqldump y gzip mostrando progreso</h1>
        <p>En un artículo anterior comentaba la posibilidad de <a title="mysqldump, backup comprimido con gzip" href="http://www.sopadebits.com/mysqldump-backup-comprimido-con-gzip">generar un &nbsp;archivo gzip a partir de un volcado de la base de datos MySQL con mysqldump</a>. Ese proceso tenía un inconveniente, y es que desconocemos el estado del progreso de esa copia de seguridad. Para bases de datos peque&ntilde;as no es un problema, pero cuando &nbsp;crece, nos podemos quedar esperando un rato largo, y sin información.</p><!--more-->
<h2>pv para mostrar el progreso de mysqldump</h2><br />
Esta es la novedad de hoy: una herramienta para mostrar el progreso dentro de una&nbsp;<em>pipe</em> de proceso. El funcionamiento es la mar de sencillo. Si tienes un archivo medianamente grande, prueba la instrucción:</p>
<pre class="brush: shell; gutter: true">cat file.txt | pv -cN cat > file2.txt</pre><br />
La instrucción anterior muestra información sobre la transferencia de bytes por la ca&ntilde;ería del proceso. No está mal, &iquest;no?</p>
<p>Así que si tomamos el ejemplo del anterior artículo:</p>
<pre>mysqldump -u [usuario] -p[clave] [base_de_datos] | gzip > [copiaseguridad.sql.gz]</pre><br />
Podemos modificarla para tener lo siguiente:</p>
<pre>mysqldump -u [usuario] -p[clave] [base_de_datos] | gzip | pv -cN gzip > [copiaseguridad.sql.gz]</pre></p>
<h2>Progreso de mysqldump conociendo el tama&ntilde;o del origen</h2><br />
Pero claro, lo anterior nos indica cuánto tama&ntilde;o estamos procesando, pero cuánto nos falta (qué porcentaje queda pendiente). Así que vamos a intentarlo. Para conseguirlo, es obvio que necesitamos un dato clave: el total del archivo a procesar. Sí, estás en lo cierto: es un peque&ntilde;o chasco porque a veces no tenemos ese dato. Pero tenemos algunas opciones. Por ejemplo, podríamos tener el tama&ntilde;o del último backup, y con ello podríamos tener una aproximación suficiente. Por ejemplo, para el caso de un archivo sql llano, tenemos lo siguiente:</p>
<pre>$ cat dump.sql | pv -cN cat -s $(du -sb dump.sql | awk &#039;{print $1}&#039;) > dump2.sql<br />
 cat: 347MB 0:00:06 [27,7MB/s] [==================> ] 43% ETA 0:00:07</pre><br />
Vale bien, &iquest;y todo esto qué es? Pues desglosándolo por partes:</p>
<ul>
<li>cat dump.sql: vuelca el contenido del archivo a la ca&ntilde;ería.</li>
<li>pv
<ul>
<li>-cN cat -> muestra el progreso del comando&nbsp;<em>cat</em>.</li>
<li>-s $(du -sb dump.sql | awk '{print $1}') -> &nbsp;Mira el tama&ntilde;o del archivo dump.sql (du -sb) y se queda sólo con el primer dato de la primer file que sale en pantalla (print $1), que son los bytes del tama&ntilde;o.</li><br />
</ul><br />
</li><br />
</ul><br />
Con esto, estamos ejecutando algo equivalente a si lo indicáramos nosotros directamente, que en el caso del archivo que he utilizado es:</p>
<pre class="brush: shell; gutter: true">$ pv -cN cat -s 828997215</pre><br />
Trasladando esto a nuestra operación anterior, tenemos:</p>
<pre>mysqldump -u [usuario] -p[clave] [base_de_datos] | gzip | pv -cN gzip -s $(gzip -l copiaseguridad-anterior.sql.gz | tail -n 1 | awk &#039;{print $2}&#039;) > [copiaseguridad.sql.gz]</pre><br />
La diferencia respecto al caso anterior es que utilizamos la instrucción gzip -l, que nos indica la lista de archivos que hay en un archivo gz (en nuestro caso sólo hay uno), tras lo cual extraemos los bytes que ocupa descomprimido. Con esto no tenemos un dato exacto, pero sí aproximado, especialmente si la base de datos es grande (el incremento entre backups acaba siendo cada vez menor).</p>
<p>Así que nada, a partir de ahora tienes la información sobre en qué punto estás... en tus backups ;-)</p>
    


        </div>
        <div class="col-xs-12 col-md-10 col-md-offset-2">
          
        </div>
        <div class="col-xs-12 col-md-offset-2">
          <p class="alert text-center">
            &copy; 2007 and beyond Mario Alberich, licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC-BY-SA</a> unless stated otherwise.
          </p>
        </div>
      </div>
    </div>
    <script type="text/javascript">
    $(document).ready(
      function (){
        $.cookieCuttr();
      }
    );
    </script>
    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/bootstrap/bootstrap.min.js"></script>
    <script src="/static/js/search.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="/static/js/cookiecuttr/jquery.cookiecuttr.js" type="text/javascript"></script>
    <script src="/static/js/cookiecuttr/js.cookie.js"></script>
  </body>
</html>
