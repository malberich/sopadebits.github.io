



<!DOCTYPE html>
<html>
    <head>
    <title>Sopa de bits</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="description" content="A blog about data, information and Tech by Mario Alberich"/>
    <meta name="keywords" content="Statistics, Data, Experimentation, Technology, Data visualization" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/static/css/bootstrap/bootstrap.css"/>
    <link rel="stylesheet" href="/static/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="/static/js/cookiecuttr/cookiecuttr.css"/>
    <link rel="stylesheet" href="/static/css/style.css"/>
    <link rel="stylesheet" href="/static/css/bootstrap/bootstrap.min.css" media="print"/>
    <link rel="stylesheet" href="/static/css/bootstrap/bootstrap-theme.min.css" media="print" />
    </head>
    <body>
    <div class="container-fluid">
      <div class="row">
        <div class="col-xs-12 col-sm-3 col-md-2 nopad-l">
          <div class="sidebar-nav-fixed affix hidden-sm">
            <div class="well">
              <div class="row">
                <!-- <div class="col-xs-12">
                  <input class="form-control" type="text" id="search-query" name="q" placeholder="Search in sopadebits.com" data-toggle="popover" autocomplete="off">
                </div> -->
                <div class="col-xs-12 text-center">
                  <a href="https://sopadebits.com"><h1>Sopa de bits</h1></a>
                </div>
                <div class="col-xs-8 col-xs-offset-2 text-center">
                  <a href="https://sopadebits.com">
                    <img src="/static/images/avatar.jpg"
                      class="img img-responsive img-circle"
                      alt="Sopa de bits"
                      title="Sopa de bits" />
                  </a>
                </div>
                <div class="col-sm-10 col-sm-offset-1 hidden-xs text-center">
                  <p>A blog about data, information and Tech by Mario Alberich</p>
                </div>
                <div class="col-sm-12 hidden-xs" rel="icons">
                  
  
    <a target="_new" href="https://linkedin.com/in/marioalberich" alt="LinkedIn" title="LinkedIn">
      <span class="icon fa fa-2x fa-linkedin"></span>
    </a>&nbsp;&nbsp;
  
  
    <a target="_new" href="https://twitter.com/sopadebits" alt="Twitter" title="Twitter">
      <span class="icon fa fa-2x fa-twitter"></span>
    </a>&nbsp;&nbsp;
  
  
  
    <a target="_new" href="https://github.com/malberich" alt="Github profile" title="Github profile">
      <span class="icon fa fa-2x fa-github"></span>
    </a>&nbsp;&nbsp;
  
  
  
    <a target="_new" href="https://marioalberich.com" alt="Portfolio" title="Portfolio">
      <span class="icon fa fa-2x fa-user"></span>
    </a>
  

                </div>
                <div class="col-sm-10 col-sm-offset-1 hidden-xs">
                  
  <!-- render_site_categories -->
  <h3>Categories</h3>
  <div class="row">
    
      <div class="col-xs-2">
        <span class="badge">45</span>
      </div>
      <div class="col-xs-10">
        <a href="/categories/documentacion/">Documentación</a>
      </div>
      <div class="col-xs-2">
        <span class="badge">40</span>
      </div>
      <div class="col-xs-10">
        <a href="/categories/economia/">Economía</a>
      </div>
      <div class="col-xs-2">
        <span class="badge">139</span>
      </div>
      <div class="col-xs-10">
        <a href="/categories/informatica/">Informática</a>
      </div>
      <div class="col-xs-2">
        <span class="badge">82</span>
      </div>
      <div class="col-xs-10">
        <a href="/categories/matematica/">Matemática</a>
      </div>
      <div class="col-xs-2">
        <span class="badge">1</span>
      </div>
      <div class="col-xs-10">
        <a href="/categories/miscelanea/">Miscelánea</a>
      </div>
      <div class="col-xs-2">
        <span class="badge">8</span>
      </div>
      <div class="col-xs-10">
        <a href="/categories/ocio/">Ocio</a>
      </div>
      <div class="col-xs-2">
        <span class="badge">11</span>
      </div>
      <div class="col-xs-10">
        <a href="/categories/personas/">Personas</a>
      </div>
      <div class="col-xs-2">
        <span class="badge">7</span>
      </div>
      <div class="col-xs-10">
        <a href="/categories/sin-categorizar/">Sin categorizar</a>
      </div>
  </div>

                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="jumbotron visible-sm visible-xs">
            <div class="row">
                <div class="col-sm-2 col-sm-offset-0 col-xs-4 col-xs-offset-4 text-center">
                    <a href="https://sopadebits.com">
                        <img src="/static/images/avatar.jpg"
                          class="img img-responsive img-circle"
                          alt="Sopa de bits"
                          title="Sopa de bits" />
                    </a>
                </div>
                <div class="col-sm-10 col-xs-12">
                    <h1 class="hidden-xs"><a href="https://sopadebits.com">Sopa de bits</a></h1>
                    <h1 class="visible-xs text-center"><a href="https://sopadebits.com">Sopa de bits</a></h1>
                </div>
              </div>
              <div class="row">
                <div class="col-sm-10 col-sm-offset-1 col-xs-12 text-center">
                  <p>A blog about data, information and Tech by Mario Alberich</p>
                </div>
                <div class="col-xs-12" rel="icons">
                  
  
    <a target="_new" href="https://linkedin.com/in/marioalberich" alt="LinkedIn" title="LinkedIn">
      <span class="icon fa fa-2x fa-linkedin"></span>
    </a>&nbsp;&nbsp;
  
  
    <a target="_new" href="https://twitter.com/sopadebits" alt="Twitter" title="Twitter">
      <span class="icon fa fa-2x fa-twitter"></span>
    </a>&nbsp;&nbsp;
  
  
  
    <a target="_new" href="https://github.com/malberich" alt="Github profile" title="Github profile">
      <span class="icon fa fa-2x fa-github"></span>
    </a>&nbsp;&nbsp;
  
  
  
    <a target="_new" href="https://marioalberich.com" alt="Portfolio" title="Portfolio">
      <span class="icon fa fa-2x fa-user"></span>
    </a>
  

                </div>
            </div>
        </div>
        <!-- <div
          id="search-results"
          style="background-color: #fff; border: 1px solid black; z-index:125; height: 50%; overflow: scroll; display: none; position:absolute" class="col-xs-12 col-sm-4 col-sm-offset-2">
        </div> -->
        <div class="col-xs-12 col-md-10 col-md-offset-2">
          
  
    
        <h1>Del blog al podcast con síntesis de voz</h1>
        <p><br />
<h2>Paso 1: Festival con voces en Espa&ntilde;ol y codificador LAME</h2>
<p>Hace tres o cuatro a&ntilde;os que descubrí el programa Festival Speech Synthesis System, desarrollado por la Universidad de Edimburgo.&nbsp; Este software diferencia sus licencias de uso en relación al propio código fuente y a las voces que contiene.&nbsp; En esencia el software es totalmente libre (con una licencia de tipo BSD), pero en el caso de las voces existen restricciones.&nbsp; Por ejemplo, las voces británicas están basadas en el <em>Oxford Advanced Learners&#39; Dictionary of Current English</em>, por lo que su uso se restringe a aplicaciones no comerciales.&nbsp; Algo similar sucede con la voz en castellano.</p><!--more-->
<p>Buscando información sobre el tema, encontré dos proyectos de creación de voces para Festival en catalán y castellano:</p>
<ul>
<li>El primero, el <a href="http://gps-tsc.upc.es/veu/festcat/" title="UPC FestCat">desarrollo de voces en catalán por la UPC</a>.&nbsp; Hay diez voces diferentes (cinco masculinas y cinco femeninas), y además con dos estructuras diferentes: HTS (Cadenas de Markov Ocultas, HMM) y clunits (Cluster units).</li>
<li>El segundo, el <a href="http://forja.guadalinex.org/repositorio/frs/?group_id=21&amp;release_id=110" title="Voces en castellano de Festival por la Junta de Andalucía">desarrollo de voces en castellano en un proyecto de la Junta de Andalucía</a>.&nbsp; En este caso los resultados se limitan a dos voces (una femenina y otra masculina), más que suficiente.</li></ul>
<p>Para la realización de estas voces se ha utilizado el conjunto de herramientas <a href="http://festvox.org/" title="FestVox">Festvox</a>, desarrolladas por el <a href="http://www.speech.cs.cmu.edu/">grupo de tecnologías de la pronunciación de la Universidad Carnegie Mellon</a>  y dirigida específicamente a la creación de voces para Festival.</p>
<p>En ambos sitios se puede encontrar información sobre el proceso de creación del corpus de sonidos, que es diferente en cada caso.&nbsp; Cabe comentar brevemente las dos versiones presentadas en el proyecto de la UPC: HTS y Clunits.</p>
<p>HTS se basa en la aplicación de modelos derivados de las Cadenas Ocultas de Markov (Hidden Markov Models - HMM) a los sistemas de síntesis de voz, como se puede leer en el sitio <a href="http://hts.sp.nitech.ac.jp/" title="HMM-based Speech Synthesis System">HMM-based Speech Synthesis System (HTS)</a>.&nbsp; Las cadenas de Markov (y por extensión las cadenas ocultas) son una herramienta de uso muy extendido, no sólo en síntesis o en reconocimiento de voz, sino también en procesamiento del lenguaje natural, o en el algoritmo del PageRank. No voy a entrar en detalles, trataré de dedicarle un artículo a este tema.</p>
<p>Para entender cómo funciona el modelo Clunits (<em>Cluster Units</em> Algoritmo de <em>clusterización</em> de unidades de sonido), hay un documento de <a href="http://www.cstr.ed.ac.uk/downloads/publications/1997/Black_1997_b.pdf" title="Cluster Units Algorithm">Alan W. Black y Paul Taylor (1997) sobre la descripción del Algoritmo</a>.</p>
<p>Después de escuchar varias versiones de ambos modelos, creo que el resultado más interesante está en el modelo Clunits, aunque las inflexiones de voz parecen más artificiales (no sabría decir si debido al modelo de creación del corpus).</p>
<p>El proceso de instalación y configuración de las voces en catalán puede leerse respectivamente en <a href="https://wiki.ubuntu.com/CatalanTeam/Tutorials/S%C3%ADntesiDeVeu?action=show&amp;redirect=CatalanTeam%2FS%C3%ADntesiDeVeu" title="Ubuntu Catalan Team Wiki: Síntesi de veu">el sitio del equipo catalán de Ubuntu</a>.&nbsp; Para las voces en castellano, recomiendo la lectura del artículo <a href="http://www.gonzalomarcote.com/blog/?p=26" title="Cómo instalar e integrar Festival en Asterisk">Cómo instalar e integrar Festival en Asterisk</a>, un caso de uso muy interesante. La cuestión clave es configurar festival para que utilice las voces correspondientes.<br /><br />Respecto a la instalación de LAME Mp3, sólo cabe decir que en Debian no existe un paquete específico, debido a las restricciones de codificación del formato MP3.&nbsp; En cualquier caso es posible <a href="http://lame.sourceforge.net/download.php" title="LAME Mp3 Encoder : Download">descargarse el paquete</a>  y compilarlo sin problemas aparentes.<br /></p><br />
<h2>Paso 2: Script de recuperación y limpieza de los contenidos</h2>
<p>Festival no está pensado como lector de páginas web en crudo, por lo que es necesario eliminar las etiquetas y las entidades HTML antes de realizar el proceso.&nbsp; Puede ser necesario convertir el texto a codificación Latin-1 porque según la documentación del proyecto, es la codificación correcta. De todos modos es una cuestión que yo no he necesitado, desconozco si las mejoras en festival han incluído soporte para UTF8.</p>
<p>Antes de empezar hay que tener en cuenta un detalle importante: al eliminar las etiquetas HTML, todo el texto se desestructura.&nbsp; Es decir, que un título no tiene una énfasis especial, ni siquiera se reconoce como frase (porque no es costumbre poner puntos al final del título).&nbsp; Tampoco he entrado a fondo en las posibilidades de Festival para personalizar el énfasis en ciertos términos o frases.</p>
<p>Así que el resultado final puede ser mejorado si existen opciones en Festival que yo no estoy utilizando y quizá remarquen puntos clave (por ejemplo, en el caso de texto en negrita).&nbsp; Además, en el proceso de conversión a texto normal, la entidad HTML "nbsp" se convierte en un "espacio raro", algo que Festival no tolera demasiado bien (de hecho parece que trague saliva).&nbsp; También los puntos seguidos deben contener un solo espacio en blanco posterior, y ninguno entre éste y la última palabra de la frase.</p>
<p>Resumiendo el proceso, los pasos a realizar antes de eliminar las etiquetas HTML son:</p>
<ul>
<li>Introducir saltos de línea antes de las etiquetas de títulos (H1..H5)</li>
<li>Introducir puntos al cierre de las etiquetas de títulos (H1..H5)</li>
<li>Introducir saltos de línea antes y después de los tags de párrafo (P)</li>
<li>Eliminar la entidad "nbsp".</li>
<li>Introducir un espacio posterior a los puntos seguidos(.), y eliminar el doble espacio posterior (".").</li>
<li>Mantener unidos los puntos suspensivos (excepción al caso anterior).</li>
<li>Cambiar los paréntesis de apertura y cierre por comas.<br /></li></ul>
<p>Una vez realizados estos cambios, hay que eliminar las etiquetas HTML (en PHP, <a href="http://es2.php.net/manual/es/function.strip-tags.php" title="PHP - strip_tags">strip_tags</a> ), y luego eliminar las entidades HTML (en PHP, <a href="http://es2.php.net/manual/es/function.html-entity-decode.php" title="PHP - html_entity_decode">html_entity_decode</a> ). En caso que sea necesario, también hay que recodificar el texto (en PHP, <a href="http://es2.php.net/manual/es/function.mb-convert-encoding.php" title="PHP - mb_convert_encoding">mb_convert_encoding</a> ).</p>
<p>Después de esto, el proceso ya llega a su fin: Hay que volcar el contenido generado a un archivo de texto, y ejecutar las dos llamadas para convertir de texto a WAV y luego a MP3 (primero <em>text2wave</em>, luego <em>lame</em>).</p><br />
<h2>Paso 3: Definición de los scripts de Ejecución text2wave y lame</h2>
<p>En Festival existe la utilidad <em>text2wave</em>, que puede ejecutarse (después de indicarse el cambio de voz en la configuración) con la siguiente llamada:</p>
<p><strong># text2wave  </strong><strong>archivo_texto </strong><strong>-o archivo_wav</strong><br /><br />Con esto se recogerán el texto de <em>archivo_texto</em>, lo convertirá en sonido y lo volcará en formato WAV en <em>archivo_wav</em>.</p>
<p>Una vez conseguido el archivo de sonido, es necesario convertirlo a formato MP3.&nbsp; Para ello se puede ejecutar el siguiente comando:</p>
<p><strong># lame -h -m m -b 92 --resample 22.05 --scale .61 --replaygain-accurate --clipdetect <em> </em>archivo_wav archivo_mp3</strong></p>
<p>Con esta instrucción se genera el sonido , con las siguientes características:<br /></p>
<ul>
<li>Codificación con calidad alta (-h). Evita algunos clicks/pops en la conversión a MP3.</li>
<li>Sonido de un canal (-m m = modo Mono).</li>
<li>Calidad de 92 kbps (-b 92): esta calidad es más que suficiente para la voz.</li>
<li>frecuencia de muestreo de 22050 Hertzios (--resample 22.05). Festival varía el ratio de muestreo según la calidad de la voz, por lo que esta opción normaliza el resultado.&nbsp; Se podría indicar 44100 hertzios (44.1) para aplicar el mismo ratio de muestreo que un CD a costa de aumentar el tama&ntilde;o del archivo.</li>
<li>escalado del valor al 61% respecto a la se&ntilde;al recibida del archivo WAV (--scale .61). En esencia reduce el volumen, pero lo que trata de evitar esta opción es el "cliqueo" (clipping) que se produce si el volumen es alto.</li>
<li>Identificar los picos de sonido para evitar el clipping (--replaygain-accurate).</li>
<li>Avisar si existe clipping (--clipdetect)<br /></li></ul>
<p>Las últimas tres opciones se incluyen para conseguir un resultado más agradable a los oídos y para recibir información sobre el resultado final. Esto es debido a que, al menos en el caso de las voces en castellano, el volumen original genera muchos clicks, probablemente debido a la concatenación de los sonidos que representan cada fonema/difonema. Dado que el tono y volumen de la voz están normalizados (y no sufren alteraciones en cada locución), se pueden establecer estos parámetros como fijos, algo que no podríamos hacer en caso de una locución humana real.<br /></p><br />
<h2>Paso 4: Disponibilidad de la audición en la interfaz web</h2>
<p>Para el último paso me he valido del programa <a href="http://flash-mp3-player.net/" title="MP3 Flash Player">Flash MP3 Player</a> , que permite incrustar un reproductor MP3 personalizable en una página web.&nbsp; El proceso en relación a lo anterior es bastante sencillo: incluir un código HTML en la página que incruste el archivo SWF del reproductor, incluyendo como parámetro la URL.<br /><br />En la propia página existe un <a href="http://flash-mp3-player.net/players/mini/generator/" title="Flash MP3 Player Mini HTML generator">generador de código para el reproductor</a>, para cada uno de los reproductores.&nbsp; El código permite la personalización de colores.<br /><br />Con esto ya está incrustado el reproductor en la página, que referencia al archivo MP3 que previamente hemos generado y que permite escucharlo sin más problemas.</p><br />
<h2>Conclusiones, otros recursos y cuestiones de accesibilidad</h2>
<p>El resultado final tiene unas cuantas ineficiencias manifiestas (pero tampoco tan críticas: se nota que ambos proyectos de creación de voz han hecho un esfuerzo notable).&nbsp; Por un lado, la pronunciación de siglas y direcciones web no siempre se acerca a unos resultados deseables.&nbsp; Aunque en el caso de las voces de la Junta de Andalucía se ha trabajado en el análisis de <em>tokens</em> para procesar direcciones de correo y direcciones web (URL), el resultado final es mejorable.<br /><br />Otro tanto sucede al escribir fragmentos de texto en otros idiomas, o instrucciones de código fuente.&nbsp; La solución a este tema pasa por utilizar tags de HTML concretos (por ejemplo en el caso del código fuente, utilizar el tag "code").&nbsp; Antes de procesar el contenido, estos tags pueden ser tratados como textos separados (para utilizar voces en el idioma original) o bien eliminados, y luego concatenar los peque&ntilde;os archivos de voz generados.&nbsp; De todos modos, esta mejora va mucho más allá de mis objetivos por ahora.&nbsp; Por no decir que el resultado es a veces tan divertido que vale la pena escucharlo para echarse unas risas <img src="/resources/tiny_mce/jscripts/tiny_mce/plugins/emotions/images/smiley-laughing.gif" border="0" alt="Riendo" title="Riendo" />.<br /><br />El reproductor MP3 de Flash no soluciona una cuestión importante: la accesibilidad.&nbsp; Por eso considero oportuno a&ntilde;adir un enlace directo al archivo MP3.&nbsp; De este modo se ofrece una opción de disponibilidad del contenido para personas con discapacidades visuales que no tengan <em>screenreaders</em> en el ordenador de consulta y que tampoco tendrían asegurado el uso del reproductor de Flash.&nbsp; También descarto la inclusión del reproductor en el contenido de los feeds porque es una funcionalidad susceptible de dar problemas en algunos programas lectores de feeds.<br /><br />Otras aplicaciones de un servicio como éste serían convertir a voz los artículos recogidos de otras fuentes de información.&nbsp; Es decir, capturar nuestros feeds habituales y convertirlos a voz sintetizada para luego escucharlos como cualquier otro podcast.&nbsp; Este caso presenta un peque&ntilde;o a&ntilde;adido en complejidad, ya que debemos controlar el idioma de la fuente y también el marcado HTML. Lo primero es fácil, pero lo segundo puede complicarse.<br /><br />Como ejemplo de este caso encontré este enlace en <a href="http://www.phpied.com/blog-to-podcast-with-ffmpeg/" title="PHPied: Blog to Podcast with FFMpeg">PHPied: conversión de feeds a podcast con ffmpeg,</a>  otra opción interesante. El uso de ffmpeg o de lame es una cuestión opcional, ya que ffmpeg requiere de un codec (que puede ser perfectamente el proporcionado por LAME). En su caso utiliza un sintetizador de Mac. Vale decir que si la fuente original está en inglés, las cosas se simplifican mucho por la disponibilidad general de sintetizadores en este idioma.<br /><br />La introducción del enlace al archivo MP3 en el RSS del blog difiere conscientemente de las especificaciones de <a href="http://www.apple.com/itunes/whatson/podcasts/specs.html" title="iTunes Technical Specification">iTunes</a>  y <a href="http://search.yahoo.com/mrss" title="Yahoo! Media RSS module technical specifications">Yahoo! Media RSS Module</a>. Este archivo no es un podcast por sí mismo, sino una versión sintetizada, y por lo tanto no es una alternativa sino una herramienta de soporte al texto.&nbsp; Con esto quiero aclarar algo: si quieres entenderlo todo, mejor acaba leyendo el artículo original. </p></p>
    


        </div>
        <div class="col-xs-12 col-md-10 col-md-offset-2">
          
        </div>
        <div class="col-xs-12 col-md-offset-2">
          <p class="alert text-center">
            &copy; 2007 and beyond Mario Alberich, licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC-BY-SA</a> unless stated otherwise.
          </p>
        </div>
      </div>
    </div>
    <script type="text/javascript">
    $(document).ready(
      function (){
        $.cookieCuttr();
      }
    );
    </script>
    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/bootstrap/bootstrap.min.js"></script>
    <script src="/static/js/search.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="/static/js/cookiecuttr/jquery.cookiecuttr.js" type="text/javascript"></script>
    <script src="/static/js/cookiecuttr/js.cookie.js"></script>
  </body>
</html>
